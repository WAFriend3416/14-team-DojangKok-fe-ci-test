# AI Server CI Pipeline
# 위치: .github/workflows/ai-ci.yml
#
# 트리거 매트릭스:
#   - PR feat/* → dev: lint, test
#   - Push dev: lint, test, build
#   - PR dev/hotfix/* → main: lint, test, build
#   - Push main: artifact

name: AI Server CI

on:
  push:
    branches: [main, dev]
    paths-ignore:
      - '.github/workflows/**'
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - '.github/workflows/**'
      - '**.md'
      - 'docs/**'

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ============================================
  # Lint (Ruff)
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff Linter
        run: ruff check .

      - name: Run Ruff Formatter Check
        run: ruff format --check .

  # ============================================
  # Test (pytest)
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-22.04
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest pytest-cov

      - name: Run Tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=. --cov-report=xml
          else
            echo "No tests directory found, skipping tests"
          fi

  # ============================================
  # Build
  # dev push, main PR에서만 실행 (main push 제외)
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-22.04
    needs: test
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/dev') ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Verify Build
        run: |
          # Python 문법 검증
          python -m py_compile $(find . -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" 2>/dev/null || echo "")
          echo "Build verification completed"

  # ============================================
  # Upload Artifact
  # main push에서만 실행
  # ============================================
  artifact:
    name: Upload Artifact
    runs-on: ubuntu-22.04
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create Artifact
        run: |
          mkdir -p dist
          # 소스코드 패키징
          tar -czvf dist/ai-server-${{ github.sha }}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='.ruff_cache' \
            --exclude='*.pyc' \
            --exclude='venv' \
            --exclude='.venv' \
            .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-server-${{ github.sha }}
          path: dist/
          retention-days: 7

  # ============================================
  # Discord Notification (Optional)
  # ============================================
  # notify:
  #   name: Discord Notification
  #   runs-on: ubuntu-22.04
  #   needs: [lint, test, build]
  #   if: always() && (needs.lint.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure')
  #   steps:
  #     - name: Discord Notification
  #       uses: sarisia/actions-status-discord@v1
  #       with:
  #         webhook: ${{ secrets.DISCORD_WEBHOOK }}
  #         title: "AI Server CI 실패"
  #         description: |
  #           **Branch**: ${{ github.ref_name }}
  #           **Commit**: ${{ github.event.head_commit.message || github.event.pull_request.title }}
  #           **Author**: ${{ github.actor }}
  #         color: 0xff0000
  #         username: "GitHub Actions"

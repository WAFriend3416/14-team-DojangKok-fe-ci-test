# AI Server Rollback Workflow
# 위치: .github/workflows/ai-rollback.yml
#
# 트리거: 수동 (workflow_dispatch)
# 목적: 이전 버전으로 롤백

name: AI Server Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: '롤백할 버전 선택'
        required: true
        type: choice
        options:
          - '1단계 이전 (직전 배포)'
          - '2단계 이전'
          - '3단계 이전'
          - '4단계 이전'
          - '5단계 이전'
      confirm:
        description: '롤백을 진행하시겠습니까? (yes 입력)'
        required: true
        type: string

env:
  GCP_PROJECT_ID: "fiery-topic-483322-b2"
  GCP_ZONE: "asia-northeast3-b"
  GCP_INSTANCE: "ai-server"
  WORKLOAD_IDENTITY_PROVIDER: "projects/7174586152/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
  SERVICE_ACCOUNT: "github-actions-sa@fiery-topic-483322-b2.iam.gserviceaccount.com"

jobs:
  # ============================================
  # Validation & Find Run ID
  # ============================================
  prepare:
    name: Prepare Rollback
    runs-on: ubuntu-22.04
    outputs:
      run_id: ${{ steps.find.outputs.run_id }}
      commit: ${{ steps.find.outputs.commit }}
    steps:
      - name: Check Confirmation
        if: ${{ github.event.inputs.confirm != 'yes' }}
        run: |
          echo "롤백이 취소되었습니다. 'yes'를 입력해주세요."
          exit 1

      - name: Parse Version Selection
        id: parse
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # "N단계 이전" 에서 N 추출
          OFFSET=$(echo "$VERSION" | grep -oE '[0-9]+')
          echo "offset=$OFFSET" >> $GITHUB_OUTPUT
          echo "Selected: $OFFSET versions ago"

      - name: Find Target Run ID
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OFFSET=${{ steps.parse.outputs.offset }}

          echo "=== 최근 CI 성공 목록 ==="
          gh run list \
            --workflow="AI Server CI" \
            --branch=main \
            --status=success \
            --limit=10 \
            --json databaseId,headSha,createdAt,displayTitle \
            --jq '.[] | "\(.databaseId) | \(.headSha[:7]) | \(.createdAt[:10]) | \(.displayTitle[:40])"'

          echo ""
          echo "=== 선택: ${OFFSET}단계 이전 ==="

          # OFFSET 번째 항목 선택 (0-indexed이므로 OFFSET-1이 아니라 OFFSET 그대로 사용)
          # 현재 배포된 버전이 index 0, 1단계 이전은 index 1
          RUN_INFO=$(gh run list \
            --workflow="AI Server CI" \
            --branch=main \
            --status=success \
            --limit=10 \
            --json databaseId,headSha,displayTitle \
            --jq ".[$OFFSET]")

          if [ -z "$RUN_INFO" ] || [ "$RUN_INFO" == "null" ]; then
            echo "해당 버전을 찾을 수 없습니다."
            exit 1
          fi

          RUN_ID=$(echo "$RUN_INFO" | jq -r '.databaseId')
          COMMIT=$(echo "$RUN_INFO" | jq -r '.headSha[:7]')
          TITLE=$(echo "$RUN_INFO" | jq -r '.displayTitle')

          echo "Run ID: $RUN_ID"
          echo "Commit: $COMMIT"
          echo "Title: $TITLE"

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

  # ============================================
  # Rollback
  # ============================================
  rollback:
    name: Rollback to ${{ needs.prepare.outputs.commit }}
    runs-on: ubuntu-22.04
    needs: prepare
    permissions:
      contents: read
      id-token: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Rollback Target
        run: |
          echo "========================================"
          echo "  롤백 대상: ${{ needs.prepare.outputs.commit }}"
          echo "  Run ID: ${{ needs.prepare.outputs.run_id }}"
          echo "========================================"

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Download Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./artifact
          echo "Downloading artifact from run: ${{ needs.prepare.outputs.run_id }}"
          gh run download ${{ needs.prepare.outputs.run_id }} --dir ./artifact

          ARTIFACT_FILE=$(find ./artifact -name "*.tar.gz" | head -1)
          if [ -z "$ARTIFACT_FILE" ]; then
            echo "Artifact not found"
            exit 1
          fi
          echo "Artifact: $ARTIFACT_FILE"
          echo "ARTIFACT_FILE=$ARTIFACT_FILE" >> $GITHUB_ENV

      - name: Upload to VM
        run: |
          gcloud compute scp ${{ env.ARTIFACT_FILE }} \
            ${{ env.GCP_INSTANCE }}:/tmp/ai-server-rollback.tar.gz \
            --zone=${{ env.GCP_ZONE }}

      - name: Deploy Rollback
        run: |
          gcloud compute ssh ${{ env.GCP_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --command='
              set -e
              echo "=== Rollback Started ==="

              # 현재 버전 백업
              BACKUP_DIR="/app/ai-server-backup-rollback-$(date +%Y%m%d%H%M%S)"
              if [ -d "/app/ai-server" ]; then
                sudo cp -r /app/ai-server "$BACKUP_DIR"
                echo "Backup: $BACKUP_DIR"
              fi

              # 서비스 중단
              sudo systemctl stop ai-server || true

              # 롤백 배포
              sudo rm -rf /app/ai-server
              sudo mkdir -p /app/ai-server
              sudo tar -xzf /tmp/ai-server-rollback.tar.gz -C /app/ai-server
              sudo chown -R jsh:jsh /app/ai-server

              # 서비스 시작
              sudo systemctl start ai-server

              # 정리
              rm -f /tmp/ai-server-rollback.tar.gz
              echo "=== Rollback Completed ==="
            '

      - name: Health Check
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.GCP_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')

          echo "Health check: http://$EXTERNAL_IP:8000/health"

          for i in {1..12}; do
            RESPONSE=$(curl -s "http://$EXTERNAL_IP:8000/health" || echo "")
            if [ -n "$RESPONSE" ]; then
              echo "✓ Health check passed"
              echo "$RESPONSE"
              exit 0
            fi
            echo "Attempt $i/12..."
            sleep 5
          done

          echo "✗ Health check failed"
          exit 1
